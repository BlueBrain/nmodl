<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>User Guide: The NMODL Framework</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_nmodl.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">User Guide
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The NMODL Framework </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><object type="image/svg+xml" data="https://github.com/BlueBrain/nmodl/actions/workflows/nmodl-ci.yml/badge.svg?branch=master" style="pointer-events: none;">github workflow</object> <a href="https://dev.azure.com/pramodskumbhar/nmodl/_build/latest?definitionId=2&amp;branchName=master"><img src="https://dev.azure.com/pramodskumbhar/nmodl/_apis/build/status/BlueBrain.nmodl?branchName=master" alt="Build Status" class="inline"/></a> <a href="https://codecov.io/gh/BlueBrain/nmodl"><object type="image/svg+xml" data="https://codecov.io/gh/BlueBrain/nmodl/branch/master/graph/badge.svg?token=A3NU9VbNcB" style="pointer-events: none;">codecov</object></a> <a href="https://bestpractices.coreinfrastructure.org/projects/4467"><img src="https://bestpractices.coreinfrastructure.org/projects/4467/badge" alt="CII Best Practices" class="inline"/></a></p>
<p>The NMODL Framework is a code generation engine for **N**EURON **MOD**eling **L**anguage (<a href="https://www.neuron.yale.edu/neuron/static/py_doc/modelspec/programmatic/mechanisms/nmodl.html">NMODL</a>). It is designed with modern compiler and code generation techniques to:</p>
<ul>
<li>Provide <b>modular tools</b> for parsing, analysing and transforming NMODL</li>
<li>Provide <b>easy to use</b>, high level Python API</li>
<li>Generate <b>optimised code</b> for modern compute architectures including CPUs, GPUs</li>
<li><b>Flexibility</b> to implement new simulator backends</li>
<li>Support for <b>full</b> NMODL specification</li>
</ul>
<h2>About NMODL</h2>
<p>Simulators like <a href="https://www.neuron.yale.edu/neuron/">NEURON</a> use NMODL as a domain specific language (DSL) to describe a wide range of membrane and intracellular submodels. Here is an example of exponential synapse specified in NMODL:</p>
<div class="fragment"><div class="line">NEURON {</div>
<div class="line">    POINT_PROCESS ExpSyn</div>
<div class="line">    RANGE tau, e, i</div>
<div class="line">    NONSPECIFIC_CURRENT i</div>
<div class="line">}</div>
<div class="line">UNITS {</div>
<div class="line">    (nA) = (nanoamp)</div>
<div class="line">    (mV) = (millivolt)</div>
<div class="line">    (uS) = (microsiemens)</div>
<div class="line">}</div>
<div class="line">PARAMETER {</div>
<div class="line">    tau = 0.1 (ms) &lt;1e-9,1e9&gt;</div>
<div class="line">    e = 0 (mV)</div>
<div class="line">}</div>
<div class="line">ASSIGNED {</div>
<div class="line">    v (mV)</div>
<div class="line">    i (nA)</div>
<div class="line">}</div>
<div class="line">STATE {</div>
<div class="line">    g (uS)</div>
<div class="line">}</div>
<div class="line">INITIAL {</div>
<div class="line">    g = 0</div>
<div class="line">}</div>
<div class="line">BREAKPOINT {</div>
<div class="line">    SOLVE state METHOD cnexp</div>
<div class="line">    i = g*(v - e)</div>
<div class="line">}</div>
<div class="line">DERIVATIVE state {</div>
<div class="line">    g&#39; = -g/tau</div>
<div class="line">}</div>
<div class="line">NET_RECEIVE(weight (uS)) {</div>
<div class="line">    g = g + weight</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Installation</h2>
<p>See <a href="https://github.com/BlueBrain/nmodl/blob/master/INSTALL.md">INSTALL.md</a> for detailed instructions to build the NMODL from source.</p>
<h2>Try NMODL with Docker</h2>
<p>To quickly test the NMODL Framework's analysis capabilities we provide a <a href="https://www.docker.com">docker</a> image, which includes the NMODL Framework python library and a fully functional Jupyter notebook environment. After installing <a href="https://docs.docker.com/compose/install/">docker</a> and <a href="https://docs.docker.com/compose/install/">docker-compose</a> you can pull and run the NMODL image from your terminal.</p>
<p>To try Python interface directly from CLI, you can run docker image as:</p>
<div class="fragment"><div class="line">docker run -it --entrypoint=/bin/sh bluebrain/nmodl</div>
</div><!-- fragment --><p>And try NMODL Python API discussed later in this README as:</p>
<div class="fragment"><div class="line">$ python3</div>
<div class="line">Python 3.6.8 (default, Apr  8 2019, 18:17:52)</div>
<div class="line">&gt;&gt;&gt; from nmodl import dsl</div>
<div class="line">&gt;&gt;&gt; import os</div>
<div class="line">&gt;&gt;&gt; examples = dsl.list_examples()</div>
<div class="line">&gt;&gt;&gt; nmodl_string = dsl.load_example(examples[-1])</div>
<div class="line">...</div>
</div><!-- fragment --><p>To try Jupyter notebooks you can download docker compose file and run it as:</p>
<div class="fragment"><div class="line">wget &quot;https://raw.githubusercontent.com/BlueBrain/nmodl/master/docker/docker-compose.yml&quot;</div>
<div class="line">DUID=$(id -u) DGID=$(id -g) HOSTNAME=$(hostname) docker-compose up</div>
</div><!-- fragment --><p>If all goes well you should see at the end status messages similar to these:</p>
<div class="fragment"><div class="line">[I 09:49:53.923 NotebookApp] The Jupyter Notebook is running at:</div>
<div class="line">[I 09:49:53.923 NotebookApp] http://(4c8edabe52e1 or 127.0.0.1):8888/?token=a7902983bad430a11935</div>
<div class="line">[I 09:49:53.923 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).</div>
<div class="line">    To access the notebook, open this file in a browser:</div>
<div class="line">        file:///root/.local/share/jupyter/runtime/nbserver-1-open.html</div>
<div class="line">    Or copy and paste one of these URLs:</div>
<div class="line">        http://(4c8edabe52e1 or 127.0.0.1):8888/?token=a7902983bad430a11935</div>
</div><!-- fragment --><p>Based on the example above you should then open your browser and navigate to the URL <code><a href="http://127.0.0.1:8888/?token=a7902983bad430a11935">http://127.0.0.1:8888/?token=a7902983bad430a11935</a></code>.</p>
<p>You can open and run all example notebooks provided in the <code>examples</code> folder. You can also create new notebooks in <code>my_notebooks</code>, which will be stored in a subfolder <code>notebooks</code> at your current working directory.</p>
<h2>Using the Python API</h2>
<p>Once the NMODL Framework is installed, you can use the Python parsing API to load NMOD file as:</p>
<div class="fragment"><div class="line">from nmodl import dsl</div>
<div class="line"> </div>
<div class="line">examples = dsl.list_examples() </div>
<div class="line">nmodl_string = dsl.load_example(examples[-1])</div>
<div class="line">driver = dsl.NmodlDriver()</div>
<div class="line">modast = driver.parse_string(nmodl_string)</div>
</div><!-- fragment --><p>The <code>parse_file</code> API returns Abstract Syntax Tree (<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>) representation of input NMODL file. One can look at the AST by converting to JSON form as:</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; print (dsl.to_json(modast))</div>
<div class="line">{</div>
<div class="line">  &quot;Program&quot;: [</div>
<div class="line">    {</div>
<div class="line">      &quot;NeuronBlock&quot;: [</div>
<div class="line">        {</div>
<div class="line">          &quot;StatementBlock&quot;: [</div>
<div class="line">            {</div>
<div class="line">              &quot;Suffix&quot;: [</div>
<div class="line">                {</div>
<div class="line">                  &quot;Name&quot;: [</div>
<div class="line">                    {</div>
<div class="line">                      &quot;String&quot;: [</div>
<div class="line">                        {</div>
<div class="line">                          &quot;name&quot;: &quot;POINT_PROCESS&quot;</div>
<div class="line">                        }</div>
<div class="line">                    ...</div>
</div><!-- fragment --><p>Every key in the JSON form represent a node in the AST. You can also use visualization API to look at the details of AST as:</p>
<div class="fragment"><div class="line">from nmodl import ast</div>
<div class="line">ast.view(modast)</div>
</div><!-- fragment --><p>which will open AST view in web browser:</p>
<p><img src="https://user-images.githubusercontent.com/666852/57329449-12c9a400-7114-11e9-8da5-0042590044ec.gif" alt="ast_viz" title="AST representation of expsyn.mod" class="inline"/></p>
<p>The central <em>Program</em> node represents the whole MOD file and each of it's children represent the block in the input NMODL file. Note that this requires X-forwarding if you are using Docker image.</p>
<p>Once the AST is created, one can use exisiting visitors to perform various analysis/optimisations. One can also easily write his own custom visitor using Python Visitor API. See <a href="docs/notebooks/nmodl-python-tutorial.ipynb">Python API tutorial</a> for details.</p>
<p>NMODL Frameowrk also allows to transform AST representation back to NMODL form as:</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; print (dsl.to_nmodl(modast))</div>
<div class="line">NEURON {</div>
<div class="line">    POINT_PROCESS ExpSyn</div>
<div class="line">    RANGE tau, e, i</div>
<div class="line">    NONSPECIFIC_CURRENT i</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">UNITS {</div>
<div class="line">    (nA) = (nanoamp)</div>
<div class="line">    (mV) = (millivolt)</div>
<div class="line">    (uS) = (microsiemens)</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">PARAMETER {</div>
<div class="line">    tau = 0.1 (ms) &lt;1e-09,1000000000&gt;</div>
<div class="line">    e = 0 (mV)</div>
<div class="line">}</div>
<div class="line">...</div>
</div><!-- fragment --><h2>High Level Analysis and Code Generation</h2>
<p>The NMODL Framework provides rich model introspection and analysis capabilities using <a href="https://bluebrain.github.io/nmodl/html/doxygen/group__visitor__classes.html">various visitors</a>. Here is an example of theoretical performance characterisation of channels and synapses from rat neocortical column microcircuit <a href="https://www.cell.com/abstract/S0092-8674%2815%2901191-5">published in 2015</a>:</p>
<p><img src="https://user-images.githubusercontent.com/666852/57336711-2cc0b200-7127-11e9-8053-8f662e2ec191.png" alt="nmodl-perf-stats" title="Example of performance characterisation" class="inline"/></p>
<p>To understand how you can write your own introspection and analysis tool, see <a href="docs/notebooks/nmodl-python-tutorial.ipynb">this tutorial</a>.</p>
<p>Once analysis and optimization passes are performed, the NMODL Framework can generate optimised code for modern compute architectures including CPUs (Intel, AMD, ARM) and GPUs (NVIDIA, AMD) platforms. For example, C++, OpenACC and OpenMP backends are implemented and one can choose these backends on command line as:</p>
<div class="fragment"><div class="line">$ nmodl expsyn.mod sympy --analytic</div>
</div><!-- fragment --><p>To know more about code generation backends, <a href="https://bluebrain.github.io/nmodl/html/doxygen/group__codegen__backends.html">see here</a>. NMODL Framework provides number of options (for code generation, optimization passes and ODE solver) which can be listed as:</p>
<div class="fragment"><div class="line">$ nmodl -H</div>
<div class="line">NMODL : Source-to-Source Code Generation Framework [version]</div>
<div class="line">Usage: /path/&lt;&gt;/nmodl [OPTIONS] file... [SUBCOMMAND]</div>
<div class="line"> </div>
<div class="line">Positionals:</div>
<div class="line">  file TEXT:FILE ... REQUIRED           One or more MOD files to process</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  -h,--help                             Print this help message and exit</div>
<div class="line">  -H,--help-all                         Print this help message including all sub-commands</div>
<div class="line">  --verbose=info                        Verbose logger output (trace, debug, info, warning, error, critical, off)</div>
<div class="line">  -o,--output TEXT=.                    Directory for backend code output</div>
<div class="line">  --scratch TEXT=tmp                    Directory for intermediate code output</div>
<div class="line">  --units TEXT=/path/&lt;&gt;/nrnunits.lib</div>
<div class="line">                                        Directory of units lib file</div>
<div class="line"> </div>
<div class="line">Subcommands:</div>
<div class="line">host</div>
<div class="line">  HOST/CPU code backends</div>
<div class="line">  Options:</div>
<div class="line">    --c                                   C/C++ backend (true)</div>
<div class="line"> </div>
<div class="line">acc</div>
<div class="line">  Accelerator code backends</div>
<div class="line">  Options:</div>
<div class="line">    --oacc                                C/C++ backend with OpenACC (false)</div>
<div class="line"> </div>
<div class="line">sympy</div>
<div class="line">  SymPy based analysis and optimizations</div>
<div class="line">  Options:</div>
<div class="line">    --analytic                            Solve ODEs using SymPy analytic integration (false)</div>
<div class="line">    --pade                                Pade approximation in SymPy analytic integration (false)</div>
<div class="line">    --cse                                 CSE (Common Subexpression Elimination) in SymPy analytic integration (false)</div>
<div class="line">    --conductance                         Add CONDUCTANCE keyword in BREAKPOINT (false)</div>
<div class="line"> </div>
<div class="line">passes</div>
<div class="line">  Analyse/Optimization passes</div>
<div class="line">  Options:</div>
<div class="line">    --inline                              Perform inlining at NMODL level (false)</div>
<div class="line">    --unroll                              Perform loop unroll at NMODL level (false)</div>
<div class="line">    --const-folding                       Perform constant folding at NMODL level (false)</div>
<div class="line">    --localize                            Convert RANGE variables to LOCAL (false)</div>
<div class="line">    --global-to-range                     Convert GLOBAL variables to RANGE (false)</div>
<div class="line">    --localize-verbatim                   Convert RANGE variables to LOCAL even if verbatim block exist (false)</div>
<div class="line">    --local-rename                        Rename LOCAL variable if variable of same name exist in global scope (false)</div>
<div class="line">    --verbatim-inline                     Inline even if verbatim block exist (false)</div>
<div class="line">    --verbatim-rename                     Rename variables in verbatim block (true)</div>
<div class="line">    --json-ast                            Write AST to JSON file (false)</div>
<div class="line">    --nmodl-ast                           Write AST to NMODL file (false)</div>
<div class="line">    --json-perf                           Write performance statistics to JSON file (false)</div>
<div class="line">    --show-symtab                         Write symbol table to stdout (false)</div>
<div class="line"> </div>
<div class="line">codegen</div>
<div class="line">  Code generation options</div>
<div class="line">  Options:</div>
<div class="line">    --layout TEXT:{aos,soa}=soa           Memory layout for code generation</div>
<div class="line">    --datatype TEXT:{float,double}=soa    Data type for floating point variables</div>
<div class="line">    --force                               Force code generation even if there is any incompatibility</div>
<div class="line">    --only-check-compatibility            Check compatibility and return without generating code</div>
<div class="line">    --opt-ionvar-copy                     Optimize copies of ion variables (false)</div>
</div><!-- fragment --><h2>Documentation</h2>
<p>We are working on user documentation, you can find current drafts of :</p>
<ul>
<li><a href="https://bluebrain.github.io/nmodl/">User Documentation</a></li>
<li><a href="https://bluebrain.github.io/nmodl/html/doxygen/index.html">Developer / API Documentation</a></li>
</ul>
<h2>Citation</h2>
<p>If you would like to know more about the the NMODL Framework, see following paper:</p>
<ul>
<li>Pramod Kumbhar, Omar Awile, Liam Keegan, Jorge Alonso, James King, Michael Hines and Felix Schürmann. 2019. An optimizing multi-platform source-to-source compiler framework for the NEURON MODeling Language. In Eprint : <a href="https://arxiv.org/pdf/1905.02241.pdf">arXiv:1905.02241</a></li>
</ul>
<h2>Support / Contribuition</h2>
<p>If you see any issue, feel free to <a href="https://github.com/BlueBrain/nmodl/issues/new">raise a ticket</a>. If you would like to improve this framework, see <a href="https://github.com/BlueBrain/nmodl/issues">open issues</a> and contribution guidelines.</p>
<h2>Examples / Benchmarks</h2>
<p>The benchmarks used to test the performance and parsing capabilities of NMODL Framework are currently being migrated to GitHub. These benchmarks will be published soon in following repositories:</p>
<ul>
<li><a href="https://github.com/BlueBrain/nmodlbench">NMODL Benchmark</a></li>
<li><a href="https://github.com/BlueBrain/nmodldb">NMODL Database</a></li>
</ul>
<h1>Funding &amp; Acknowledgment</h1>
<p>The development of this software was supported by funding to the Blue Brain Project, a research center of the École polytechnique fédérale de Lausanne (EPFL), from the Swiss government's ETH Board of the Swiss Federal Institutes of Technology. In addition, the development was supported by funding from the National Institutes of Health (NIH) under the Grant Number R01NS11613 (Yale University) and the European Union’s Horizon 2020 Framework Programme for Research and Innovation under the Specific Grant Agreement No. 785907 (Human Brain Project SGA2).</p>
<p>Copyright © 2017-2023 Blue Brain Project, EPFL </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
  <ul>
  </ul>
</div>
<hr class="footer"/>
<address class="footer">
    <small>
    </small>
</address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>

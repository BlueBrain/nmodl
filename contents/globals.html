<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Variables &mdash; NMODL 0.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Longitudinal Diffusion" href="longitudinal_diffusion.html" />
    <link rel="prev" title="Cable Equation" href="cable_equations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            NMODL
          </a>
              <div class="version">
                0.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">The NMODL Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installing the NMODL Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language.html">The NEURON MODeling language</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="visitors.html">Visitors</a></li>
<li class="toctree-l1"><a class="reference internal" href="currents.html">Currents</a></li>
<li class="toctree-l1"><a class="reference internal" href="ions.html">Ions</a></li>
<li class="toctree-l1"><a class="reference internal" href="pointers.html">NMODL “pointers”</a></li>
<li class="toctree-l1"><a class="reference internal" href="cable_equations.html">Cable Equation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Global Variables</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">GLOBAL variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#top-local-variables">Top-LOCAL variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thread-variables">Thread Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-values">Initial Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hoc-python-access">HOC/Python Access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementation-details-for-neuron">Implementation Details for NEURON</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quirks">Quirks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#parameter-variables">PARAMETER variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#default-values">Default Values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#constant-variables">CONSTANT variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Quirks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#what-does-coreneuron-support">What Does CoreNEURON support?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="longitudinal_diffusion.html">Longitudinal Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cvode.html">Variable timestep integration (CVODE)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jupyter Notebooks:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notebooks.html">The NMODL Jupyter notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-python-tutorial.html">NMODL Python Interface Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-odes-overview.html">NMODL integration of ODEs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-kinetic-schemes.html">NMODL Kinetic Scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-sympy-solver-cnexp.html">NMODL SympySolver - cnexp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-sympy-solver-sparse.html">NMODL SympySolver - sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-sympy-solver-derivimplicit.html">NMODL SympySolver - derivimplicit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-linear-solver.html">NMODL LINEAR solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-nonlinear-solver.html">NMODL NONLINEAR solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/nmodl-sympy-conductance.html">NMODL CONDUCTANCE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing to the NMODL Framework</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Python package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C++ API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NMODL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Global Variables</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/contents/globals.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="global-variables">
<h1>Global Variables<a class="headerlink" href="#global-variables" title="Permalink to this heading"></a></h1>
<p>The following global variables exist:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GLOBAL</span></code> visible from HOC/Python.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOCAL</span></code> at file scope, called top-locals.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONSTANT</span></code> not visible from HOC/Python.</p></li>
</ul>
</div></blockquote>
<section id="id1">
<h2>GLOBAL variables<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>GLOBAL variables behave in one of three different ways:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>read-only</strong> if the variable is not written to from inside the MOD file,
is considered read-only. It behaves like there’s a single instance that’s
shared across all threads. Currently, they’re implemented as a static
<code class="docutils literal notranslate"><span class="pre">double</span></code>, i.e. a regular C/C++ global variable. This MOD file is (still)
thread-safe.</p></li>
<li><p><strong>read-write</strong> Setting a value via <code class="docutils literal notranslate"><span class="pre">PARAMETER</span></code> is not considered a
write-access. While setting the value from within the MOD file in all other
contexts, including <code class="docutils literal notranslate"><span class="pre">INITIAL</span></code>, counts as a write-access.</p>
<ul>
<li><p><strong>THREAD_SAFE:</strong>, if the MOD file is marked thread-safe, then the
assumption is that it’s safe to create multiple instances of the global
variable, e.g. one per thread. We call these <em>thread-variables</em>. This MOD
file is considered thread-safe.</p></li>
<li><p><strong>Not THREAD_SAFE:</strong> if the MOD file is not stated to be <code class="docutils literal notranslate"><span class="pre">THREADSAFE</span></code>,
then the assumption is that the global variables must behave like a
single instance would. As a result, these MOD files are not thread-safe.</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p>The visibility of GLOBAL variables it the following:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>ASSIGNED:</strong> any GLOBAL variable that appears in an ASSIGNED block
is not visible from HOC/Python.</p></li>
<li><p><strong>PARAMETER:</strong> any GLOBAL variable that appears in a PARAMETER block
is visible (read/write) from HOC/Python. Any PARAMETER that’s not
explicitly made a RANGE variable is considered a GLOBAL.</p></li>
<li><p><strong>undefined:</strong> any GLOBAL variable that’s not listed in either an ASSIGNED
or PARAMETER block is treated as if it were ASSIGNED, i.e. it’s not visible
from HOC/Python.</p></li>
</ul>
</div></blockquote>
</section>
<section id="top-local-variables">
<h2>Top-LOCAL variables<a class="headerlink" href="#top-local-variables" title="Permalink to this heading"></a></h2>
<p>Top-LOCAL variables are LOCAL variables at file-scope. They are never visible
from HOC/Python and always treated as top-local variables.</p>
<p>Since top-locals can’t be assigned a value from HOC/Python and assignment in
INITIAL blocks counts as a write-access, the only way of assigning a value to a
read-only top-local would be in the PARAMETER block. However, variables
mentioned in PARAMETER are always RANGE or GLOBAL variables; and it’s not
allowed to have two global variables with the same name. Therefore, read-only
top-locals aren’t possible.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">nocmodl</span></code> promotes all top-local variables to thread-variables, even
if the MOD file isn’t marked with <code class="docutils literal notranslate"><span class="pre">THREADSAFE</span></code>. Hence, top-local variables are
always thread-variables.</p>
</section>
<section id="thread-variables">
<h2>Thread Variables<a class="headerlink" href="#thread-variables" title="Permalink to this heading"></a></h2>
<p>Thread variables can be safely used as scratch-pad memory. Historically,
they’ve been advertised as an optimization technique that reduces the memory
footprint.</p>
<p>The canonical example is <code class="docutils literal notranslate"><span class="pre">hh.mod</span></code>. The common pattern is that they’re used as
return values from a PROCEDURE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DERIVATIVE</span> <span class="n">states</span> <span class="p">{</span>
  <span class="n">rates</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="n">m</span><span class="s1">&#39; =  (minf-m)/mtau</span>
<span class="p">}</span>

<span class="n">PROCEDURE</span> <span class="n">rates</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="n">mV</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">TABLE</span> <span class="n">minf</span><span class="p">,</span> <span class="n">mtau</span> <span class="n">DEPEND</span> <span class="n">celsius</span> <span class="n">FROM</span> <span class="o">-</span><span class="mi">100</span> <span class="n">TO</span> <span class="mi">100</span> <span class="n">WITH</span> <span class="mi">200</span>

  <span class="n">minf</span> <span class="o">=</span> <span class="o">...</span>
  <span class="n">mtau</span> <span class="o">=</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What we see is that for every instance we compute the value <code class="docutils literal notranslate"><span class="pre">minf</span></code> and
<code class="docutils literal notranslate"><span class="pre">mtau</span></code>, before we use them in <code class="docutils literal notranslate"><span class="pre">states</span></code>. Technically there’s no need for one
copy per instance of the mechanism. For example in Python one could write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minf</span><span class="p">,</span> <span class="n">mtau</span> <span class="o">=</span> <span class="n">rates</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="n">minf</span><span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">mtau</span>
</pre></div>
</div>
<p>Therefore, if the author doesn’t need to record the value of <code class="docutils literal notranslate"><span class="pre">minf</span></code> and
<code class="docutils literal notranslate"><span class="pre">mtau</span></code>, then using RANGE variables might be considered wasting memory. Under
these circumstances, and before multi-threading existed, the solution was to use
a GLOBAL. When multi-core processors arrived, these MOD files were suddenly not
thread-safe. The solution was to introduce a keyword <code class="docutils literal notranslate"><span class="pre">THREADSAFE</span></code> and create
one copy of the global per thread.</p>
<section id="initial-values">
<h3>Initial Values<a class="headerlink" href="#initial-values" title="Permalink to this heading"></a></h3>
<p>Note that thread-variables ignore the initial value set in the PARAMETER block
entirely.</p>
<p>For INITIAL blocks the requirement is that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INITIAL</span> <span class="p">{</span>
  <span class="n">gbl</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>guarantees that all copies of <code class="docutils literal notranslate"><span class="pre">gbl</span></code> are assigned the value <code class="docutils literal notranslate"><span class="pre">2.0</span></code>.</p>
</section>
<section id="hoc-python-access">
<h3>HOC/Python Access<a class="headerlink" href="#hoc-python-access" title="Permalink to this heading"></a></h3>
<p>Note that there’s no synchronization when setting or writing to
thread-variables. What happens is that is acts the (or a) value of thread 0.
The value on other threads is either left unchanged when writing or ignored
when reading the global variable.</p>
</section>
<section id="implementation-details-for-neuron">
<h3>Implementation Details for NEURON<a class="headerlink" href="#implementation-details-for-neuron" title="Permalink to this heading"></a></h3>
<p>NMODL distinguishes between top-local variables and GLOBAL variables at the
level of the AST. Then for code-generation we introduce the concept of
“thread-variables”. All top-locals are considered thread-variables. GLOBAL
variables that are <strong>read-write</strong> and THREADSAFE can be converted to thread
variables.</p>
<p>Since thread-variables are permitted to have multiple copies per thread, we can
generalize this to be multiple copies per thread and SIMD lane; or one copy per
instance of the mechanism for GPUs (effectively a RANGE variable similar to
what CoreNEURON does).</p>
<p>Registering GLOBAL variables for access from HOC/Python happens via</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">DoubScal</span> <span class="n">hoc_scdoub</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">&quot;g_w_shared_global&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_w_shared_global</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">static</span> <span class="n">DoubVec</span> <span class="n">hoc_vdoub</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">&quot;g_arr_shared_global&quot;</span><span class="p">,</span> <span class="n">g_arr_shared_global</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">hoc_register_var</span><span class="p">(</span><span class="n">hoc_scdoub</span><span class="p">,</span> <span class="n">hoc_vdoub</span><span class="p">,</span> <span class="n">hoc_intfunc</span><span class="p">);</span>
</pre></div>
</div>
<p>which means for each global we register a stable address (e.g. the address of
some static variable) individually. The elements of ARRAY valued globals must
be stored contiguously.</p>
<p>The strategy is the following: each instance of the mechanism is associated
with a specific, not necessarily unique, copy of the thread-variable. For SIMD
this allows us to compute the copy of the thread-variable using modulo
arithmetic; on a GPU one could either assign a copy to each variable; or use
scratch pad memory (e.g. <code class="docutils literal notranslate"><span class="pre">__shared__</span></code> memory when using CUDA).</p>
</section>
<section id="quirks">
<h3>Quirks<a class="headerlink" href="#quirks" title="Permalink to this heading"></a></h3>
<p>Collection of slightly surprising behaviour:</p>
<blockquote>
<div><ul class="simple">
<li><p>Thread variables effectively can’t be use in NET_RECEIVE blocks, because
the code <code class="docutils literal notranslate"><span class="pre">nocmodl</span></code> produces will cause a SEGFAULT.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="parameter-variables">
<h2>PARAMETER variables<a class="headerlink" href="#parameter-variables" title="Permalink to this heading"></a></h2>
<p>These can be either RANGE or not RANGE. They can be both read and write. If
they’re written to, they’re converted to thread-variables. Therefore, the rest
of this section will only describe read-only PARAMETERs.</p>
<p>Additionally, parameters optionally have: a) a default value, b) units and c) a
valid range.</p>
<section id="default-values">
<h3>Default Values<a class="headerlink" href="#default-values" title="Permalink to this heading"></a></h3>
<p>This section only applies to read-only PARAMETERs.</p>
<p>The behaviour differs for RANGE variables and non-RANGE variables. For RANGE
variables, default values need to be registered with NEURON for all PARAMETERs
that are RANGE variables. The function is called <code class="docutils literal notranslate"><span class="pre">hoc_register_parm_default</span></code>.</p>
<p>Note, that NOCMODL uses it in the <code class="docutils literal notranslate"><span class="pre">nrn_alloc</span></code> in the generated <cite>.cpp</cite> files
and also in <code class="docutils literal notranslate"><span class="pre">ndatclas.cpp</span></code>. Therefore, it seems registering the values isn’t
optional.</p>
<p>Non-RANGE variables are semantically equivalent to <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">double</span></code>. They’re
simply assigned their value in the definition of the global variable.</p>
</section>
</section>
<section id="constant-variables">
<h2>CONSTANT variables<a class="headerlink" href="#constant-variables" title="Permalink to this heading"></a></h2>
<p>These are comparatively simple. In NOCMODL they’re implemented as non-const
static doubles. They’re not accessible from HOC/Python (which makes them
simple).</p>
<section id="id2">
<h3>Quirks<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>In certain versions of NOCMODL around <cite>9.0</cite> and before (and NMODL) it’s
possible to change the value of CONSTANT variables. The MOD file will still be
considered “thread-safe” (even if it might not be).</p>
</section>
</section>
<section id="what-does-coreneuron-support">
<h2>What Does CoreNEURON support?<a class="headerlink" href="#what-does-coreneuron-support" title="Permalink to this heading"></a></h2>
<p>CoreNEURON only supports read-only GLOBAL variables. Anything else needs to be
converted to a RANGE variable manually.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cable_equations.html" class="btn btn-neutral float-left" title="Cable Equation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="longitudinal_diffusion.html" class="btn btn-neutral float-right" title="Longitudinal Diffusion" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, BlueBrain HPC team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>